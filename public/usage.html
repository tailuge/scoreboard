<!doctype html>
<html lang="en">
  <head>
    <title>Billiards Usage Dashboard</title>
    <link rel="icon" type="image/png" href="golden-cup.png" />
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="description" content="Billiards Usage Dashboard" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="usage.css" />
  </head>

  <body>
    <header class="header">
      <h1 class="title">Billiards Usage Dashboard</h1>
      <div class="server-stats-links">
        <a href="https://vercel.com/tailuges-projects/~/usage" target="_blank"
          >Vercel Stats</a
        >
        <a
          href="https://dashboard.render.com/web/srv-ctk5bmtds78s73eteil0/metrics"
          target="_blank"
          >Render Stats</a
        >
      </div>
    </header>
    <main class="chart-grid">
      <div id="lobby" class="chart-container"></div>
      <div id="createTable" class="chart-container"></div>
      <div id="joinTable" class="chart-container"></div>
      <div id="game" class="chart-container"></div>
    </main>

    <script
      src="https://cdn.plot.ly/plotly-cartesian-3.0.0-rc.0.min.js"
      integrity="sha384-k9BNvphELWyBtQVTUBS5YYM9SAb3H4NoA6hxg6YARuWJqdp+yp8F3mJN405LN+KC"
      crossorigin="anonymous"
    ></script>

    <script type="module">
      Promise.all([
        plotMetric("lobby"),
        plotMetric("createTable"),
        plotMetric("joinTable"),
        plotMetric("game"),
      ])

      async function getData(url) {
        const response = await fetch(url)
        return response.json()
      }

      async function plotMetric(metric) {
        const url = `/api/usage/${metric}`
        const rawData = await getData(url)
        // e.g rawData = [ { "date": "2024-12-30" }, 1, { "date": "2024-12-31" }, 3 ]
        const data = []

        // Convert raw data into a usable format for Plotly
        for (let i = 0; i < rawData.length; i += 2) {
          data.push({ date: rawData[i].date, clicks: rawData[i + 1] })
        }

        data.sort((a, b) => new Date(a.date) - new Date(b.date))

        // Prepare data for Plotly
        const dates = data.map((item) => item.date)
        const clicks = data.map((item) => item.clicks)

        const plotData = [
          {
            x: dates,
            y: clicks,
            type: "scatter",
            mode: "lines+markers",
            marker: {
              color: "var(--primary-glow)",
              size: 8,
              symbol: "circle-open",
              line: {
                color: "var(--primary-glow)",
                width: 2,
              },
            },
            line: {
              color: "var(--primary-glow)",
              width: 3,
              shape: "spline",
              smoothing: 0.7,
            },
            hoverinfo: "x+y",
            hovertemplate: "<b>%{x}</b><br>Interactions: %{y}<extra></extra>",
          },
        ]

        const layout = {
          title: {
            text: metric.replace(/([A-Z])/g, " $1").toUpperCase(),
            font: {
              family: "var(--font-display)",
              size: 18,
              color: "var(--primary-glow)",
            },
            x: 0.5,
            y: 0.95,
          },
          xaxis: {
            type: "category",
            tickangle: -45,
            gridcolor: "var(--grid-line-color)",
            linecolor: "var(--grid-line-color)",
            tickfont: {
              family: "var(--font-body)",
              size: 12,
              color: "var(--text-color)",
            },
            dtick: Math.ceil(dates.length / 10), // Show around 10 ticks
          },
          yaxis: {
            title: {
              text: "INTERACTIONS",
              font: {
                family: "var(--font-body)",
                size: 12,
                color: "var(--text-color)",
              },
            },
            gridcolor: "var(--grid-line-color)",
            linecolor: "var(--grid-line-color)",
            tickfont: {
              family: "var(--font-body)",
              size: 12,
              color: "var(--text-color)",
            },
            zerolinecolor: "var(--secondary-glow)",
          },
          plot_bgcolor: "transparent",
          paper_bgcolor: "transparent",
          hovermode: "x unified",
          margin: { t: 60, r: 40, b: 80, l: 60 },
        }

        const config = {
          responsive: true,
          displayModeBar: false,
        }

        // Render the chart
        Plotly.newPlot(metric, plotData, layout, config)
      }
    </script>
  </body>
</html>
