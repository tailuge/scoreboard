<!doctype html>
<html lang="en">
  <head>
    <title>Support Terminal: Usage</title>
    <link rel="icon" type="image/png" href="golden-cup.png" />
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta
      name="description"
      content="A TUI-inspired dashboard for monitoring usage metrics."
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="usage.css" />
  </head>
  <body>
    <header class="header">
      <h1 class="title">SUPPORT TERMINAL: USAGE</h1>
      <div class="server-stats-links">
        <a href="https://vercel.com/tailuges-projects/~/usage" target="_blank"
          >VERCEL</a
        >
        <a
          href="https://dashboard.render.com/web/srv-ctk5bmtds78s73eteil0/metrics"
          target="_blank"
          >RENDER</a
        >
      </div>
    </header>
    <main class="chart-grid">
      <div id="lobby" class="chart-container"></div>
      <div id="createTable" class="chart-container"></div>
      <div id="joinTable" class="chart-container"></div>
      <div id="game" class="chart-container"></div>
    </main>

    <script
      src="https://cdn.plot.ly/plotly-cartesian-3.0.0-rc.0.min.js"
      integrity="sha384-k9BNvphELWyBtQVTUBS5YYM9SAb3H4NoA6hxg6YARuWJqdp+yp8F3mJN405LN+KC"
      crossorigin="anonymous"
    ></script>

    <script type="module">
      Promise.all([
        plotMetric("lobby"),
        plotMetric("createTable"),
        plotMetric("joinTable"),
        plotMetric("game"),
      ])

      async function getData(url) {
        const response = await fetch(url)
        return response.json()
      }

      async function plotMetric(metric) {
        const url = `/api/usage/${metric}`
        const rawData = await getData(url)
        // e.g rawData = [ { "date": "2024-12-30" }, 1, { "date": "2024-12-31" }, 3 ]
        const data = []

        // Convert raw data into a usable format for Plotly
        for (let i = 0; i < rawData.length; i += 2) {
          data.push({ date: rawData[i].date, clicks: rawData[i + 1] })
        }

        data.sort((a, b) => new Date(a.date) - new Date(b.date))

        // Prepare data for Plotly
        const dates = data.map((item) => item.date)
        const clicks = data.map((item) => item.clicks)

        const plotData = [
          {
            x: dates,
            y: clicks,
            type: "scatter",
            mode: "lines",
            line: { color: "#0055ff", width: 2 },
            hoverinfo: "x+y",
            hovertemplate: "<b>%{x}</b><br>CLICKS: %{y}<extra></extra>",
          },
        ]

        const layout = {
          title: {
            text: metric.toUpperCase(),
            font: {
              family: "'IBM Plex Mono', monospace",
              size: 12,
              color: "#1a1a1a",
            },
            x: 0.05,
            xanchor: "left",
          },
          xaxis: {
            type: "category",
            tickangle: 0,
            gridcolor: "#eaeaea",
            linecolor: "#eaeaea",
            tickfont: {
              family: "'DM Sans', sans-serif",
              size: 10,
              color: "#1a1a1a",
            },
            zeroline: false,
          },
          yaxis: {
            gridcolor: "#eaeaea",
            linecolor: "#eaeaea",
            tickfont: {
              family: "'DM Sans', sans-serif",
              size: 10,
              color: "#1a1a1a",
            },
            zeroline: false,
          },
          plot_bgcolor: "rgba(0,0,0,0)",
          paper_bgcolor: "rgba(0,0,0,0)",
          hovermode: "x unified",
          margin: { t: 40, r: 20, b: 50, l: 30 },
          autosize: true,
        }

        const config = {
          responsive: true,
          displayModeBar: false,
        }

        Plotly.newPlot(metric, plotData, layout, config)
      }
    </script>
  </body>
</html>
